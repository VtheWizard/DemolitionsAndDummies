<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <canvas id="game" width="440" height="440" style="border:1px solid #000000;"></canvas>
    <script>        
        const socket = new WebSocket('ws://127.0.0.1:8080/ws');
        
        socket.onopen = () => {
            console.log('connection established');
        }

        document.addEventListener('keydown', function(event) {
            switch (event.key) {
                case 'w':
                    playerPosition.row--;
                    socket.send(JSON.stringify({ type: "new_player_position", playerPosition}));
                    break;
                case 'a':
                    playerPosition.col--;
                    socket.send(JSON.stringify({ type: "new_player_position", playerPosition}));
                    break;
                case 's':
                    playerPosition.row++;
                    socket.send(JSON.stringify({ type: "new_player_position", playerPosition}));
                    break;
                case 'd':
                    playerPosition.col++;
                    socket.send(JSON.stringify({ type: "new_player_position", playerPosition}));
                    break;
                case ' ':
                    socket.send(JSON.stringify({ type: "bomb_set", bomb_location: [1,0]}))
                    break;
            }
        });

        socket.onmessage = (event) => {
            const message = JSON.parse(event.data);
            console.log(message)

            if (message.type == "new_player_position") {
                console.log("new_player_position")
                newLocation.row = message.new_position.x
                newLocation.col = message.new_position.y
                updatePlayer();
            }

            if (message.type == "grid_init") {
                initGrid(message.cells);
            }

            if (message.type == "bomb_set") {
                drawPlayer(message.bombPosition.x, message.bombPosition.y, 6, "blue"); 
            }

        };

        const canvas = document.getElementById("game");
        const ctx = canvas.getContext("2d");

        const cellSize = 40;

        let playerPosition = { row: 0, col: 0 };
        let playerLastPosition = { row: 0, col: 0 };
        let newLocation = { row: 0, col: 0 }; // this data is from server

        function initGrid(cells) {
            console.log(cells);
            for (let row = 0; row < cells.length; row++) {
                for (let col = 0; col < cells[0].length; col++) {
                    const x = col * cellSize;
                    const y = row * cellSize;

                    if (cells[row][col] === 2) {
                        ctx.fillStyle = 'DimGray';
                    } else if (cells[row][col] === 1) {
                        ctx.fillStyle = 'DarkGray';
                    } else {
                        ctx.fillStyle = 'white';
                    }

                    ctx.fillRect(x, y, cellSize, cellSize);
                    ctx.strokeStyle = 'black';
                    ctx.strokeRect(x, y, cellSize, cellSize);
                }
            }
        }

        function drawPlayer(row, col, radius, color) {
            const centerX = col * cellSize + cellSize / 2;
            const centerY = row * cellSize + cellSize / 2;

            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
            ctx.fillStyle = color;
            ctx.fill();
            ctx.closePath();
        }

        function clearCell(row, col) {
            const x = col * cellSize;
            const y = row * cellSize;
            ctx.clearRect(x, y, cellSize, cellSize);
            ctx.strokeStyle = 'black';
            ctx.strokeRect(x, y, cellSize, cellSize);
        }

        function updatePlayer() {
            // clear moved from cell
            clearCell(playerLastPosition.row, playerLastPosition.col);
            playerLastPosition.row = playerPosition.row;
            playerLastPosition.col = playerPosition.col;

            // clear moved to cell
            clearCell(playerPosition.row, playerPosition.col);
            playerPosition.row = newLocation.row;
            playerPosition.col = newLocation.col;
            
            // draw red player
            drawPlayer(playerPosition.row, playerPosition.col, 10, "red"); 
        }

    </script>
</body>
</html>